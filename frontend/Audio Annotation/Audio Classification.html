<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Classification Annotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="px-6 py-4 flex items-center justify-between">
      <!-- Left side - File info -->
      <div class="flex items-center space-x-4">
        <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold text-gray-900" id="fileName">Audio.mp3</h1>
          <p class="text-sm text-gray-500">Audio Classification Annotation</p>
        </div>
      </div>
      
      <!-- Right side - Actions -->
      <div class="flex items-center space-x-3">
        <a href="/frontend/Datasets.html" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center space-x-2" id="backBtn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          <span>Back to project</span>
        </a>
        <button class="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg hover:bg-gray-800 flex items-center space-x-2" id="saveBtn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
          </svg>
          <span>Save Annotation</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="flex-1 grid grid-cols-1 xl:grid-cols-4 gap-0">
    <!-- Left Panel - Audio Player (75% width on xl screens) -->
    <div class="xl:col-span-3 p-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        
        <!-- Controls Row -->
        <div class="p-6 pb-4">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <!-- File Upload -->
            <div class="flex-shrink-0">
              <label class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>
                Select Audio File
                <input type="file" accept="audio/*" class="hidden" id="fileInput">
              </label>
            </div>
            <!-- Playback Controls -->
            <div class="flex items-center space-x-3">
              <button class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors disabled:opacity-50" id="playBtn" disabled>
                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20" id="playIcon">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                </svg>
              </button>
              <button class="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50" id="back10" disabled>
                <span class="text-xs">-10s</span>
              </button>
              <button class="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50" id="fwd10" disabled>
                <span class="text-xs">+10s</span>
              </button>
            </div>
            <!-- Time & Speed -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
              <div class="text-lg font-mono font-medium text-gray-900" id="timeDisplay">0:00 / 0:00</div>
              <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">Speed</label>
                <select class="text-sm border border-gray-300 rounded-lg px-3 py-1 bg-white" id="speedSelect">
                  <option value="0.5">0.5x</option>
                  <option value="0.75">0.75x</option>
                  <option value="1" selected>1x</option>
                  <option value="1.25">1.25x</option>
                  <option value="1.5">1.5x</option>
                  <option value="2">2x</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <!-- Waveform Container -->
        <div class="px-6 pb-6">
          <div class="bg-gradient-to-r from-yellow-400 via-red-500 via-pink-500 via-purple-500 to-blue-500 rounded-2xl p-6 shadow-inner">
            <div id="waveform" class="min-h-[160px] rounded-xl bg-black bg-opacity-10"></div>
            <div class="flex justify-between items-center mt-4 text-white text-sm font-mono">
              <span id="currentTime">00:00:000</span>
              <span id="totalTime">/ 00:00:000</span>
            </div>
          </div>
        </div>

      </div>
    </div>
    <!-- Right Panel - Annotation Tools (25% width on xl screens) -->
    <div class="xl:col-span-1 bg-gray-50 border-l border-gray-200">
      <div class="p-6">
        <!-- Panel Header -->
        <div class="flex items-center space-x-2 mb-6">
          <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
          </svg>
          <h2 class="text-lg font-semibold text-gray-900">Annotation Tools</h2>
        </div>
        <!-- Audio Properties -->
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-900 mb-4">Audio Properties</h3>
          
          <form id="annotationForm" class="space-y-4">
            <!-- Audio Type -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Audio Type</label>
              <select name="audioType" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                <option value="">Select type...</option>
                <option value="Speech">Speech</option>
                <option value="Music">Music</option>
                <option value="Noise">Noise</option>
                <option value="Podcast">Podcast</option>
                <option value="Call">Call</option>
                <option value="Environment">Environment</option>
              </select>
            </div>
            <!-- Quality -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Quality</label>
              <select name="quality" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                <option value="">Select quality...</option>
                <option value="Excellent">Excellent</option>
                <option value="Good">Good</option>
                <option value="Fair">Fair</option>
                <option value="Poor">Poor</option>
              </select>
            </div>
            <!-- Emotion/Mood -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Emotion/Mood</label>
              <select name="emotion" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                <option value="">Select emotion...</option>
                <option value="Neutral">Neutral</option>
                <option value="Happy">Happy</option>
                <option value="Sad">Sad</option>
                <option value="Angry">Angry</option>
                <option value="Calm">Calm</option>
                <option value="Excited">Excited</option>
              </select>
            </div>
            <!-- Background Noise -->
            <div class="flex items-center space-x-2">
              <input type="checkbox" id="backgroundNoise" name="backgroundNoise" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              <label for="backgroundNoise" class="text-sm font-medium text-gray-700">Has background noise</label>
            </div>
            <!-- Notes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
              <textarea name="notes" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="Additional notes (optional)..."></textarea>
            </div>
            <!-- Classify Button -->
            <button type="button" id="classifyBtn" class="w-full bg-gray-900 text-white px-3 py-2 rounded text-xs font-medium hover:bg-gray-800 transition-colors flex items-center justify-center space-x-1 mt-4">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              <span>Classify Current Segment</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Save Modal -->
  <div id="saveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Annotation Saved</h3>
      </div>
      <div class="p-6">
        <pre id="jsonOutput" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-auto max-h-96 font-mono"></pre>
      </div>
      <div class="p-6 border-t border-gray-200 flex justify-end">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800">Close</button>
      </div>
    </div>
  </div>
  <script>
    // Global variables
    let wavesurfer = null;
    let currentAudioFile = null;
    let segments = [];
    let animationFrameId = null;

    // Utility functions
    const formatTime = (seconds) => {
    if (!seconds || !isFinite(seconds)) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
    };

    const formatTimeWithMs = (seconds) => {
    if (!seconds || !isFinite(seconds)) return "00:00:000";
    const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
    const ms = Math.floor((seconds % 1) * 1000).toString().padStart(3, '0');
    return `${minutes}:${secs}:${ms}`;
    };

    // Initialize WaveSurfer
    function initWaveSurfer() {
    if (wavesurfer) {
        wavesurfer.destroy();
    }

    wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: 'rgba(255, 255, 255, 0.8)',
        progressColor: 'rgba(255, 255, 255, 1)',
        cursorColor: '#ffffff',
        barWidth: 2,
        barGap: 1,
        height: 160,
        normalize: true,
        backend: 'WebAudio',
        responsive: true,
        fillParent: true,
    });

    // Event listeners
    wavesurfer.on('ready', () => {
        // Enable controls
        document.getElementById('playBtn').disabled = false;
        document.getElementById('back10').disabled = false;
        document.getElementById('fwd10').disabled = false;
        
        updateTimeDisplay();
        startTimeLoop();
    });

    wavesurfer.on('finish', () => {
        updatePlayButton(false);
    });

    return wavesurfer;
    }

    // Time update loop
    function startTimeLoop() {
    function update() {
        if (wavesurfer) {
        updateTimeDisplay();
        animationFrameId = requestAnimationFrame(update);
        }
    }
    update();
    }

    function stopTimeLoop() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    }

    function updateTimeDisplay() {
    if (!wavesurfer) return;
    
    const currentTime = wavesurfer.getCurrentTime() || 0;
    const duration = wavesurfer.getDuration() || 0;
    
    document.getElementById('currentTime').textContent = formatTimeWithMs(currentTime);
    document.getElementById('totalTime').textContent = `/ ${formatTimeWithMs(duration)}`;
    document.getElementById('timeDisplay').textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
    }

    function updatePlayButton(isPlaying) {
    const playIcon = document.getElementById('playIcon');
    if (isPlaying) {
        playIcon.innerHTML = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>';
    } else {
        playIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>';
    }
    }

    // Event listeners
    document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Update filename
    document.getElementById('fileName').textContent = file.name;
    
    // Clean up previous file
    if (currentAudioFile) {
        URL.revokeObjectURL(currentAudioFile);
    }
    
    currentAudioFile = URL.createObjectURL(file);
    
    // Initialize wavesurfer and load file
    initWaveSurfer();
    
    try {
        await wavesurfer.load(currentAudioFile);
    } catch (error) {
        console.error('Error loading audio:', error);
        alert('Error loading audio file. Please try a different format.');
    }
    });

    document.getElementById('playBtn').addEventListener('click', () => {
    if (!wavesurfer) return;
    
    wavesurfer.playPause();
    updatePlayButton(wavesurfer.isPlaying());
    });

    document.getElementById('back10').addEventListener('click', () => {
    if (!wavesurfer) return;
    const currentTime = wavesurfer.getCurrentTime();
    wavesurfer.setTime(Math.max(0, currentTime - 10));
    });

    document.getElementById('fwd10').addEventListener('click', () => {
    if (!wavesurfer) return;
    const currentTime = wavesurfer.getCurrentTime();
    const duration = wavesurfer.getDuration();
    wavesurfer.setTime(Math.min(duration, currentTime + 10));
    });

    document.getElementById('speedSelect').addEventListener('change', (e) => {
    if (!wavesurfer) return;
    wavesurfer.setPlaybackRate(parseFloat(e.target.value));
    });

    // Annotation functions
    document.getElementById('classifyBtn').addEventListener('click', () => {
    if (!wavesurfer || !wavesurfer.getDecodedData()) {
        alert('Please select and load an audio file first.');
        return;
    }

    const form = document.getElementById('annotationForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    if (!data.audioType || !data.quality || !data.emotion) {
        alert('Please fill in all required fields (Audio Type, Quality, Emotion).');
        return;
    }

    const currentTime = wavesurfer.getCurrentTime();
    const duration = wavesurfer.getDuration();
    
    const segment = {
        id: Date.now(),
        start: Math.max(0, currentTime - 5),
        end: Math.min(duration, currentTime + 5),
        audioType: data.audioType,
        quality: data.quality,
        emotion: data.emotion,
        backgroundNoise: form.backgroundNoise.checked,
        notes: data.notes || ''
    };

    addSegment(segment);
    });

    function addSegment(segment) {
    segments.push(segment);
    
    const segmentElement = document.createElement('div');
    segmentElement.className = 'bg-white border border-gray-200 rounded-lg p-3';
    segmentElement.innerHTML = `
        <div class="flex justify-between items-start">
        <div class="flex-1">
            <div class="text-sm font-medium text-gray-900">${segment.audioType}</div>
            <div class="text-xs text-gray-500 mt-1">
            ${segment.quality} • ${segment.emotion}${segment.backgroundNoise ? ' • Noise' : ''}
            </div>
            <div class="text-xs text-gray-400 mt-1">
            ${formatTimeWithMs(segment.start)} - ${formatTimeWithMs(segment.end)}
            </div>
        </div>
        <div class="flex space-x-1 ml-2">
            <button onclick="jumpToSegment(${segment.start})" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700">
            Jump
            </button>
            <button onclick="deleteSegment(${segment.id})" class="text-xs px-2 py-1 bg-red-100 hover:bg-red-200 rounded text-red-700">
            Delete
            </button>
        </div>
        </div>
    `;
    
    document.getElementById('segmentsList').appendChild(segmentElement);
    }

    function jumpToSegment(time) {
    if (wavesurfer) {
        wavesurfer.setTime(time);
    }
    }

    function deleteSegment(segmentId) {
    segments = segments.filter(s => s.id !== segmentId);
    // Reload segments display
    const segmentsList = document.getElementById('segmentsList');
    segmentsList.innerHTML = '';
    segments.forEach(addSegment);
    }

    // Save annotation
    document.getElementById('saveBtn').addEventListener('click', () => {
    const fileName = document.getElementById('fileName').textContent || 'Audio.mp3';
    const annotation = {
        fileName: fileName,
        duration: wavesurfer?.getDuration() || 0,
        segments: segments,
        createdAt: new Date().toISOString()
    };

    const jsonString = JSON.stringify(annotation, null, 2);
    
    // Show modal
    document.getElementById('jsonOutput').textContent = jsonString;
    document.getElementById('saveModal').classList.remove('hidden');
    
    // Download file
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName.replace(/\.[^/.]+$/, '') + '_annotation.json';
    link.click();
    URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>