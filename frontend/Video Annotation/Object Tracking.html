<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Action Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .progress-line {
            background: white;
            width: 2px;
            height: 100%;
            position: absolute;
            top: 0;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
            z-index: 10;
            transition: left 0.1s ease;
        }
        .timeline-progress {
            background: #3b82f6;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.1s ease;
        }
        .timeline-segment {
            position: absolute;
            height: 100%;
            background: rgba(255, 165, 0, 0.6);
            border-right: 2px solid #ff6b35;
            z-index: 5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-6 h-6 bg-blue-500 rounded flex items-center justify-center text-white">
                    <i class="bi bi-play-fill text-sm"></i>
                </div>
                <div>
                    <h1 id="fileName" class="text-lg font-semibold text-gray-900">Video.mp4</h1>
                    <p class="text-xs text-gray-500">Action Recognition</p>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-md bg-white text-gray-700 text-sm font-medium hover:bg-gray-50">
                <i class="bi bi-arrow-left"></i>
                <a href="/frontend/Datasets.html">Back to project</a>
            </button>
            <button id="saveBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-md text-sm font-medium hover:bg-gray-800">
                <i class="bi bi-save"></i>
                Save Annotation
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel -->
        <div class="flex-1 bg-white p-6 flex flex-col">
            <!-- Upload Section -->
            <div class="mb-6">
                <label for="fileInput" class="inline-flex items-center gap-2 px-5 py-3 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-pointer hover:border-gray-400 hover:bg-gray-100">
                    <i class="bi bi-file-earmark-play"></i>
                    Select Audio File
                </label>
            </div>

            <!-- Video Container - Larger -->
            <div id="videoContainer" class="w-full h-96 md:h-[500px] bg-black rounded-lg mb-6 flex items-center justify-center relative overflow-hidden cursor-pointer">
                <video id="videoPlayer" controls class="w-full h-full object-contain hidden"></video>
                <div id="videoPlaceholder" class="text-gray-400 text-lg">
                    Uploaded Video
                </div>
            </div>

            <!-- Controls Bar - Wider and Centered -->
            <div class="flex items-center justify-center gap-6 mb-6 px-4">
                <button id="playPauseBtn" class="w-12 h-12 border border-gray-300 rounded-lg bg-white flex items-center justify-center hover:bg-gray-50 text-gray-700">
                    <i class="bi bi-play-fill text-xl"></i>
                </button>

                <div class="flex items-center gap-3">
                    <button id="seekBackBtn" class="w-10 h-10 border border-gray-300 rounded-lg bg-white flex items-center justify-center hover:bg-gray-50 text-gray-700">
                        <i class="bi bi-skip-start-fill"></i>
                    </button>
                    <span class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-xs text-gray-600">-10s</span>
                </div>

                <div class="flex items-center gap-3">
                    <button id="seekForwardBtn" class="w-10 h-10 border border-gray-300 rounded-lg bg-white flex items-center justify-center hover:bg-gray-50 text-gray-700">
                        <i class="bi bi-skip-end-fill"></i>
                    </button>
                    <span class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-xs text-gray-600">+10s</span>
                </div>

                <div class="flex items-center gap-3">
                    <span class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-xs text-gray-600">Speed</span>
                    <select id="speedSelect" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>

            <!-- Timeline with Moving Progress Line -->
            <div class="mb-4">
                <div class="relative">
                    <div id="timeline" class="w-full h-6 bg-gray-200 rounded-full cursor-pointer overflow-hidden relative">
                        <div id="timelineProgress" class="timeline-progress absolute top-0 left-0 w-0"></div>
                        <div id="progressLine" class="progress-line" style="left: 0%"></div>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-2 text-sm text-gray-600">
                    <span id="currentTime">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
        </div>

        <!-- Right Panel - Annotation Tools -->
        <div class="w-96 bg-white border-l border-gray-200 flex flex-col">
            <div class="bg-gray-200 px-5 py-4 border-b border-gray-300">
                <div class="flex items-center gap-2 text-gray-900 font-semibold">
                    <i class="bi bi-tools"></i>
                    Annotation Tools
                </div>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto">
                <!-- Object Types Section -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Object Types</h3>
                    <div id="objectList" class="space-y-0">
                        <div class="object-item flex items-center justify-between p-3 border border-gray-300 bg-white cursor-pointer first:rounded-t-md last:rounded-b-md -mb-px" data-object="Person">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                                <span class="font-medium">Person</span>
                            </div>
                            <i class="bi bi-check-circle-fill text-green-600 hidden check-icon"></i>
                        </div>

                        <div class="object-item flex items-center justify-between p-3 border border-gray-300 bg-white cursor-pointer  first:rounded-t-md last:rounded-b-md -mb-px" data-object="Vehicle">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                </svg>
                                <span class="font-medium">Vehicle</span>
                            </div>
                            <i class="bi bi-check-circle-fill text-green-600 hidden check-icon"></i>
                        </div>

                        <div class="object-item flex items-center justify-between p-3 border border-gray-300 bg-white cursor-pointer  first:rounded-t-md last:rounded-b-md -mb-px" data-object="Animal">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M4.5 9.5C4.5 8.67 3.83 8 3 8S1.5 8.67 1.5 9.5 2.17 11 3 11s1.5-.67 1.5-1.5zM21 8c-.83 0-1.5.67-1.5 1.5S20.17 11 21 11s1.5-.67 1.5-1.5S21.83 8 21 8zM6 9.5C6 8.67 5.33 8 4.5 8S3 8.67 3 9.5 3.67 11 4.5 11 6 10.33 6 9.5zM8.5 8C7.67 8 7 8.67 7 9.5S7.67 11 8.5 11 10 10.33 10 9.5 9.33 8 8.5 8zm7 0c-.83 0-1.5.67-1.5 1.5S14.67 11 15.5 11 17 10.33 17 9.5 16.33 8 15.5 8zM20.5 8c-.83 0-1.5.67-1.5 1.5S19.67 11 20.5 11 22 10.33 22 9.5 21.33 8 20.5 8zM12 14c-2.67 0-5.33 1.33-8 4 2.67-2.67 5.33-4 8-4s5.33 1.33 8 4c-2.67-2.67-5.33-4-8-4z"/>
                                </svg>
                                <span class="font-medium">Animal</span>
                            </div>
                            <i class="bi bi-check-circle-fill text-green-600 hidden check-icon"></i>
                        </div>

                        <div class="object-item flex items-center justify-between p-3 border border-gray-300 bg-white cursor-pointer  first:rounded-t-md last:rounded-b-md" data-object="Object">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1z"/>
                                </svg>
                                <span class="font-medium">Object</span>
                            </div>
                            <i class="bi bi-check-circle-fill text-green-600 hidden check-icon"></i>
                        </div>
                    </div>
                </div>

                <!-- Tracking Controls Section -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Tracking Controls</h3>
                    <div class="space-y-0">
                        <button class="tracking-btn w-full flex items-center justify-start gap-3 p-3 border border-gray-300 bg-white first:rounded-t-md last:rounded-b-md -mb-px" data-action="start-tracking">
                            <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/>
                            </svg>
                            <span class="font-medium">Start Tracking</span>
                        </button>

                        <button class="tracking-btn w-full flex items-center justify-start gap-3 p-3 border border-gray-300 bg-white  first:rounded-t-md last:rounded-b-md -mb-px" data-action="interpolate-frames">
                            <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                            </svg>
                            <span class="font-medium">Interpolate Frames</span>
                        </button>

                        <button class="tracking-btn w-full flex items-center justify-start gap-3 p-3 border border-gray-300 bg-white  first:rounded-t-md last:rounded-b-md" data-action="delete-track">
                            <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            <span class="font-medium">Delete Track</span>
                        </button>
                    </div>
                </div>

                <!-- Instructions Section -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Instructions</h3>
                    <div class="mb-4">
                        <ol class="text-xs text-gray-600 leading-relaxed pl-4 space-y-1">
                            <li>1. Select an Object type</li>
                            <li>2. Draw bounding box on video</li>
                            <li>3. Use controls to track through frames</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="video/*" class="hidden">

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoContainer = document.getElementById('videoContainer');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const fileName = document.getElementById('fileName');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const seekBackBtn = document.getElementById('seekBackBtn');
        const seekForwardBtn = document.getElementById('seekForwardBtn');
        const speedSelect = document.getElementById('speedSelect');
        const timeline = document.getElementById('timeline');
        const timelineProgress = document.getElementById('timelineProgress');
        const progressLine = document.getElementById('progressLine');
        const currentTime = document.getElementById('currentTime');
        const duration = document.getElementById('duration');
        const saveBtn = document.getElementById('saveBtn');
        const objectList = document.getElementById('objectList');

        // State
        let selectedObject = null;
        let markers = [];
        let pendingStartTime = null;

        // Format time helper
        function formatTime(seconds) {
            if (!isFinite(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update progress bar and moving line
        function updateProgress() {
            if (!videoPlayer.duration) return;
            
            const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            timelineProgress.style.width = progress + '%';
            progressLine.style.left = progress + '%';
        }

        // File upload handler
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                const videoURL = URL.createObjectURL(file);
                videoPlayer.src = videoURL;
                videoPlayer.classList.remove('hidden');
                videoPlaceholder.classList.add('hidden');
                videoPlayer.load();
            }
        });

        videoContainer.addEventListener('click', function() {
            if (!videoPlayer.src) fileInput.click();
        });

        playPauseBtn.addEventListener('click', function() {
            if (!videoPlayer.src) return;
            if (videoPlayer.paused) {
                videoPlayer.play();
                playPauseBtn.innerHTML = '<i class="bi bi-pause-fill text-xl"></i>';
            } else {
                videoPlayer.pause();
                playPauseBtn.innerHTML = '<i class="bi bi-play-fill text-xl"></i>';
            }
        });

        videoPlayer.addEventListener('play', function() {
            playPauseBtn.innerHTML = '<i class="bi bi-pause-fill text-xl"></i>';
        });

        videoPlayer.addEventListener('pause', function() {
            playPauseBtn.innerHTML = '<i class="bi bi-play-fill text-xl"></i>';
        });

        seekBackBtn.addEventListener('click', () => {
            if (videoPlayer.src) videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
        });

        seekForwardBtn.addEventListener('click', () => {
            if (videoPlayer.src) videoPlayer.currentTime = Math.min(videoPlayer.duration || 0, videoPlayer.currentTime + 10);
        });

        speedSelect.addEventListener('change', function() {
            if (videoPlayer.src) videoPlayer.playbackRate = parseFloat(this.value);
        });

        // Time update with progress animation
        videoPlayer.addEventListener('timeupdate', function() {
            const time = formatTime(videoPlayer.currentTime);
            currentTime.textContent = time;
            updateProgress();
        });

        videoPlayer.addEventListener('loadedmetadata', function() {
            const dur = formatTime(videoPlayer.duration);
            duration.textContent = dur;
            updateProgress();
        });

        // Timeline click for seeking
        timeline.addEventListener('click', function(e) {
            if (!videoPlayer.duration) return;
            
            const rect = timeline.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const percentage = clickX / rect.width;
            const timeInSeconds = percentage * videoPlayer.duration;
            
            videoPlayer.currentTime = timeInSeconds;
        });

        // Object selection with Tailwind classes
        objectList.addEventListener('click', function(e) {
            const objectItem = e.target.closest('.object-item');
            if (objectItem) {
                document.querySelectorAll('.object-item').forEach(item => {
                    item.classList.remove('bg-gray-900', 'text-white');
                    item.classList.add('bg-white', 'text-gray-700');
                    item.querySelector('.check-icon').classList.add('hidden');
                    item.querySelector('svg').classList.remove('text-white');
                    item.querySelector('svg').classList.add('text-gray-700');
                });
                
                objectItem.classList.remove('bg-white', 'text-gray-700');
                objectItem.classList.add('bg-gray-900', 'text-white');
                objectItem.querySelector('.check-icon').classList.remove('hidden');
                objectItem.querySelector('svg').classList.remove('text-gray-700');
                objectItem.querySelector('svg').classList.add('text-white');
                selectedObject = objectItem.dataset.object;
            }
        });

        // Tracking controls
        document.querySelectorAll('.tracking-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                
                if (!selectedObject && action !== 'delete-track') {
                    alert('Please select an object type first');
                    return;
                }

                switch(action) {
                    case 'start-tracking':
                        console.log('Starting tracking for:', selectedObject);
                        alert(`Starting tracking for ${selectedObject}`);
                        break;
                    case 'interpolate-frames':
                        console.log('Interpolating frames for:', selectedObject);
                        alert(`Interpolating frames for ${selectedObject}`);
                        break;
                    case 'delete-track':
                        console.log('Deleting track');
                        alert('Deleting current track');
                        break;
                }
            });
        });

        saveBtn.addEventListener('click', function() {
            const annotations = {
                videoFile: fileName.textContent,
                duration: videoPlayer.duration || 0,
                selectedObject: selectedObject,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(annotations, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = 'video-annotations.json';
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>